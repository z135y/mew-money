<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA ERP Pro v4.4 (Tea Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .input-dark { background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; color: white; transition: all 0.2s; }
        .input-dark:focus { border-color: #10b981; outline: none; }
        .nav-btn.active { background-color: #1e293b; color: #34d399; border-right: 3px solid #34d399; }
        
        #authOverlay { position: fixed; inset: 0; background: #020617; z-index: 50; display: flex; align-items: center; justify-content: center; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body onload="checkLoginStatus()">

    <!-- ğŸ” å®‰å…¨ç™»å…¥å±¤ -->
    <div id="authOverlay">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center border-t-4 border-emerald-500 shadow-2xl shadow-emerald-900/20">
            <h1 class="text-3xl font-bold text-white mb-2"><i class="fa-solid fa-leaf text-emerald-400 mr-2"></i>èŒ¶è‘‰å±•å”®ç³»çµ±</h1>
            <p class="text-slate-400 mb-6 text-sm">SCA Secure ERP v4.4</p>
            
            <div class="relative mb-4">
                <input type="password" id="authKey" class="input-dark w-full p-4 rounded-lg text-center text-xl tracking-widest" placeholder="è«‹è¼¸å…¥é‡‘é‘°">
                <div class="absolute right-4 top-4 text-slate-500 cursor-pointer" onclick="togglePassword()">
                    <i class="fa-solid fa-eye" id="eyeIcon"></i>
                </div>
            </div>

            <button onclick="login()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition shadow-lg shadow-emerald-900/30 flex justify-center items-center gap-2">
                <i class="fa-solid fa-unlock-keyhole"></i> é©—è­‰ä¸¦ç™»å…¥
            </button>
            
            <p id="loginMsg" class="text-red-400 text-sm mt-4 min-h-[20px] font-bold"></p>
            
            <div class="mt-6 text-xs text-slate-600 border-t border-slate-700 pt-4 text-left px-4">
                <p class="mb-1"><i class="fa-solid fa-circle text-emerald-500 text-[8px] mr-1"></i> é€£ç·šé‡‘é‘°ï¼š<span class="text-emerald-400 font-mono">0926</span> (åŒæ­¥å¾Œç«¯)</p>
                <p><i class="fa-solid fa-circle text-amber-500 text-[8px] mr-1"></i> é›¢ç·šæ¸¬è©¦ï¼š<span class="text-amber-400 font-mono">8888</span> (åƒ…æœ¬æ©Ÿ)</p>
            </div>
        </div>
    </div>

    <!-- ä¸»ç³»çµ±ä»‹é¢ -->
    <div id="appContainer" class="flex h-screen overflow-hidden opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20 hidden md:flex" id="sidebar">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-xl font-bold text-emerald-400 flex items-center gap-2">
                    <i class="fa-solid fa-server text-xs"></i> SCA ERP
                </h1>
                <p class="text-xs text-slate-500 mt-1 pl-1">Backend Integrated</p>
                <div id="connectionStatus" class="mt-2 text-xs flex items-center gap-1 text-slate-600">
                    <span class="w-2 h-2 rounded-full bg-gray-500"></span> æª¢æŸ¥ä¸­...
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div class="text-xs font-bold text-slate-600 uppercase mb-2 px-2">Front Office</div>
                <button onclick="switchTab('pos')" id="nav-pos" class="nav-btn active w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-cash-register w-5 text-center"></i> å±•å”®æ”¶éŠ€å°
                </button>
                <button onclick="switchTab('inventory')" id="nav-inventory" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-boxes-stacked w-5 text-center"></i> åº«å­˜ç›¤é»
                </button>
                
                <div class="text-xs font-bold text-slate-600 uppercase mb-2 px-2 mt-4">Back Office</div>
                <button onclick="switchTab('expense')" id="nav-expense" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-receipt w-5 text-center"></i> è²»ç”¨å ±æ”¯
                </button>
                <button onclick="switchTab('report')" id="nav-report" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> è²¡å‹™å ±è¡¨
                </button>
            </nav>
            
            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full text-xs text-red-400 hover:text-red-300 text-center py-2 border border-red-900/50 rounded hover:bg-red-900/20 transition">
                    <i class="fa-solid fa-power-off mr-1"></i> å®‰å…¨ç™»å‡º
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-gradient-to-br from-slate-900 to-slate-800 w-full">
            
            <!-- Mobile Toggle -->
            <button onclick="document.getElementById('sidebar').classList.toggle('hidden');" class="md:hidden absolute top-4 right-4 text-white z-50 bg-slate-800 p-2 rounded">
                <i class="fa-solid fa-bars"></i>
            </button>

            <!-- Tab 1: POS -->
            <div id="pos" class="tab-content active max-w-7xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">å±•å”®æœƒæ”¶éŠ€å°</h2>
                        <p class="text-xs text-slate-400 mt-1"><i class="fa-solid fa-tag text-emerald-500"></i> ä¿ƒéŠ·ä¸­ï¼šä»»é¸å…©å…¥ 85 æŠ˜ (èŒ¶åŒ…å»ºè­°æ’é™¤)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadProducts()" class="text-sm bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-white transition">
                            <i class="fa-solid fa-rotate"></i> åŒæ­¥å¾Œç«¯
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-10rem)]">
                    <div class="lg:col-span-2 overflow-y-auto pr-2 pb-10">
                        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    </div>
                    
                    <div class="glass-panel p-0 rounded-xl flex flex-col h-full lg:h-auto overflow-hidden">
                        <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-white"><i class="fa-solid fa-cart-shopping mr-2"></i>ç•¶å‰è¨‚å–®</h3>
                            <button onclick="clearCart()" class="text-xs text-red-400 hover:text-red-300">æ¸…ç©º</button>
                        </div>
                        
                        <div id="cartItems" class="flex-1 space-y-2 overflow-y-auto p-4">
                            <div class="text-center text-slate-600 mt-10 text-sm">å°šæœªåŠ å…¥å•†å“</div>
                        </div>

                        <div class="bg-slate-900/90 p-5 space-y-3 border-t border-slate-700 backdrop-blur-md">
                            <div class="flex justify-between text-sm text-slate-400">
                                <span>åŸåƒ¹å°è¨ˆ</span>
                                <span id="cartSubtotal">$0</span>
                            </div>
                            <div class="flex justify-between items-center bg-emerald-900/20 p-2 rounded border border-emerald-900/50 hidden" id="discountRow">
                                <span class="text-xs text-emerald-400 font-bold"><i class="fa-solid fa-gift mr-1"></i>ä»»å…©ä»¶85æŠ˜</span>
                                <span class="text-emerald-400 text-sm" id="discountAmount">-$0</span>
                            </div>
                            <div class="flex justify-between text-2xl font-bold text-white border-t border-slate-700 pt-3">
                                <span>å¯¦æ”¶é‡‘é¡</span>
                                <span id="cartFinalTotal" class="text-emerald-400">$0</span>
                            </div>
                            
                            <div id="profitWarning" class="hidden text-xs text-red-400 bg-red-900/20 p-1 rounded text-center">
                                <i class="fa-solid fa-triangle-exclamation"></i> æ³¨æ„ï¼šæœ¬å–®é ä¼°è™§æ (èŒ¶åŒ…æˆæœ¬éé«˜)
                            </div>

                            <input type="text" id="posNote" class="input-dark w-full p-2 rounded text-sm mt-2" placeholder="ğŸ“ è¨‚å–®å‚™è¨» (é¸å¡«)">
                            <button onclick="submitSale()" id="btnSale" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition shadow-lg mt-2">
                                çµå¸³æ”¶æ¬¾ (å¯«å…¥å¾Œç«¯)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Inventory -->
            <div id="inventory" class="tab-content max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400">åº«å­˜ç®¡ç†</h2>
                    <span class="text-slate-500 text-sm">å³æ™‚åº«å­˜ç›£æ§ (è³‡æ–™ä¾†æºï¼šGoogle Sheets)</span>
                </div>
                <div class="glass-panel p-0 rounded-xl border-t-4 border-cyan-500 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-900/50"><tr><th class="p-4">å“å</th><th class="p-4">æˆæœ¬</th><th class="p-4">å”®åƒ¹</th><th class="p-4">ç•¶å‰åº«å­˜</th></tr></thead>
                        <tbody id="inventoryList" class="text-sm divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 3: Expense -->
            <div id="expense" class="tab-content max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-blue-400">è²»ç”¨å ±æ”¯</h2>
                <div class="glass-panel p-8 rounded-xl border-t-4 border-blue-500 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="expAmount" class="input-dark w-full p-3 rounded" placeholder="é‡‘é¡ (NTD)">
                        <select id="expTag" class="input-dark w-full p-3 rounded">
                            <option value="staff">ä¼™é£Ÿè²»</option>
                            <option value="travel">æ—…è²»</option>
                            <option value="client">äº¤éš›è²»</option>
                            <option value="misc">é›œæ”¯</option>
                        </select>
                    </div>
                    <input type="text" id="expDesc" class="input-dark w-full p-3 rounded" placeholder="è²»ç”¨èªªæ˜">
                    <button onclick="submitExpense()" id="btnExp" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded font-bold transition">æäº¤å ±æ”¯</button>
                </div>
            </div>

            <!-- Tab 4: Reports -->
            <div id="report" class="tab-content max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-amber-400">è²¡å‹™å ±è¡¨</h2>
                <div class="flex gap-2 mb-4">
                    <input type="date" id="rptStart" class="input-dark p-2 rounded">
                    <input type="date" id="rptEnd" class="input-dark p-2 rounded">
                    <button onclick="getReport()" class="bg-amber-600 px-4 rounded text-white font-bold">æŸ¥è©¢</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-slate-400 text-sm mb-2">å€é–“éŠ·è²¨æ”¶å…¥</h3>
                        <div class="text-4xl font-bold text-emerald-400" id="rpt-revenue">$0</div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-slate-400 text-sm mb-2">å€é–“æ·¨åˆ© (Net Income)</h3>
                        <div class="text-4xl font-bold text-amber-400" id="rpt-net">$0</div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-xl mt-6">
                   <div class="text-xs text-slate-500">* å ±è¡¨æ•¸æ“šç”±å¾Œç«¯å³æ™‚é‹ç®—ç”¢ç”Ÿ (å«ç¨…é¡åˆ†é›¢)</div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ==========================================
        // âš ï¸ã€é—œéµè¨­å®šã€‘è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google Web App URL âš ï¸
        // ==========================================
        const API_URL = "åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„_Google_Script_Web_App_Url"; 
        
        // é‡‘é‘°è¨­å®š
        const OFFLINE_KEY = "8888";  // é›¢ç·šæ¸¬è©¦ç”¨
        const BACKEND_KEY = "0926";  // æ‚¨å¾Œç«¯è¨­å®šçš„ API_SECRET

        // æœ¬åœ°é è¨­è³‡æ–™ (é›¢ç·šæ¨¡å¼ç”¨)
        const LOCAL_PRODUCTS = [
            { id: "TEA001", name: "ç‰¹é¸ç´…çƒé¾", price: 450, cost: 160, qty: 14, tag: "ç†±éŠ·" },
            { id: "TEA002", name: "å‡é ‚çƒé¾", price: 350, cost: 160, qty: 4 },
            { id: "TEA003", name: "èœœé¦™ç´…èŒ¶", price: 300, cost: 160, qty: 20 },
            { id: "TEA004", name: "åªæ—åŒ…ç¨®", price: 250, cost: 160, qty: 32 },
            { id: "TEA005", name: "èŒ¶åŒ… (10å…¥)", price: 90, cost: 160, qty: 40, isLossLeader: true }
        ];

        let productList = []; 
        let cart = [];
        let sessionKey = null;
        let isOfflineMode = false;

        function checkLoginStatus() {
            if(API_URL.includes("åœ¨æ­¤è™•è²¼ä¸Š")) {
                alert("âš ï¸ è«‹æ³¨æ„ï¼šæ‚¨å°šæœªè¨­å®š Google Script ç¶²å€ï¼\nè«‹ç·¨è¼¯ HTML ç¬¬ 193 è¡Œï¼Œå¡«å…¥éƒ¨ç½²å¾Œçš„ç¶²å€ã€‚");
            }
            const storedKey = sessionStorage.getItem("sca_api_key");
            if (storedKey) {
                document.getElementById('authKey').value = storedKey;
                login();
            }
        }

        function togglePassword() {
            const input = document.getElementById('authKey');
            input.type = input.type === "password" ? "text" : "password";
        }

        async function login() {
            const key = document.getElementById('authKey').value;
            if (!key) return;
            
            document.getElementById('loginMsg').innerText = "é€£ç·šé©—è­‰ä¸­...";
            
            // æ¨¡å¼åˆ¤æ–·
            if (key === OFFLINE_KEY) {
                activateOfflineMode();
            } else if (key === BACKEND_KEY) {
                try {
                    // å˜—è©¦é€£ç·šå¾Œç«¯
                    const res = await fetch(`${API_URL}?action=get_products&auth=${key}`);
                    const data = await res.json();
                    
                    if (data.status === "error" && data.msg === "Unauthorized") {
                        document.getElementById('loginMsg').innerText = "âŒ å¯†ç¢¼éŒ¯èª¤ (å¾Œç«¯æ‹’çµ•)";
                        return;
                    }

                    sessionKey = key;
                    sessionStorage.setItem("sca_api_key", key);
                    isOfflineMode = false;
                    enterSystem("Online");
                    
                    if(data.products) {
                        productList = data.products;
                        renderProductGrid();
                        renderInventoryList();
                    }
                } catch (e) {
                    if(confirm("ç„¡æ³•é€£ç·šè‡³å¾Œç«¯ (è«‹ç¢ºèª URL æ˜¯å¦æ­£ç¢º)ã€‚\næ˜¯å¦åˆ‡æ›ç‚ºé›¢ç·šæ¨¡å¼ï¼Ÿ")) {
                        activateOfflineMode();
                    } else {
                        document.getElementById('loginMsg').innerText = "âŒ é€£ç·šå¤±æ•—";
                    }
                }
            } else {
                document.getElementById('loginMsg').innerText = "âŒ é‡‘é‘°ç„¡æ•ˆ (è«‹è¼¸å…¥ 0926 æˆ– 8888)";
            }
        }

        function activateOfflineMode() {
            sessionKey = OFFLINE_KEY;
            isOfflineMode = true;
            productList = [...LOCAL_PRODUCTS];
            enterSystem("Offline");
            renderProductGrid();
            renderInventoryList();
        }

        function enterSystem(mode) {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('appContainer').style.opacity = '1';
            document.getElementById('appContainer').style.pointerEvents = 'auto';
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = mode === "Offline" 
                ? `<span class="w-2 h-2 rounded-full bg-amber-500"></span> é›¢ç·šæ¨¡å¼` 
                : `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> å·²é€£ç·šè‡³å¾Œç«¯`;
        }

        function logout() {
            sessionStorage.removeItem("sca_api_key");
            location.reload();
        }

        // ==========================================
        // ğŸ“¦ æ¥­å‹™é‚è¼¯ (POS & Cart)
        // ==========================================

        async function loadProducts() {
            if (isOfflineMode) {
                productList = JSON.parse(JSON.stringify(LOCAL_PRODUCTS));
                renderProductGrid(); renderInventoryList();
                alert("å·²é‡ç½®æœ¬åœ°æ•¸æ“š");
                return;
            }
            try {
                const res = await fetch(`${API_URL}?action=get_products&auth=${sessionKey}`);
                const data = await res.json();
                if(data.status === "success") {
                    productList = data.products;
                    renderProductGrid(); renderInventoryList();
                }
            } catch(e) { console.error(e); }
        }

        function renderProductGrid() {
            document.getElementById('productGrid').innerHTML = productList.map(p => `
                <div onclick="addToCart('${p.id}')" 
                     class="glass-panel p-4 rounded-xl cursor-pointer hover:bg-slate-700 transition active:scale-95 border-l-4 ${p.qty < 5 ? 'border-red-500' : 'border-emerald-500'} flex flex-col justify-between relative overflow-hidden group h-32">
                    <div class="relative z-10">
                        <div class="text-slate-100 font-bold text-lg">${p.name}</div>
                        ${p.tag ? `<span class="text-[10px] bg-red-600 px-1.5 py-0.5 rounded text-white inline-block mb-1">${p.tag}</span>` : ''}
                    </div>
                    <div class="flex justify-between items-end relative z-10">
                        <div class="text-emerald-400 font-mono text-xl font-bold">$${p.price}</div>
                        <div class="text-xs ${p.qty<5?'text-red-400 font-bold animate-pulse':'text-slate-400'}">åº«å­˜: ${p.qty}</div>
                    </div>
                </div>`).join('');
        }

        function renderInventoryList() {
            document.getElementById('inventoryList').innerHTML = productList.map(p => `
                <tr class="border-b border-slate-700 hover:bg-slate-800">
                    <td class="p-4 font-bold text-slate-200">${p.name}</td>
                    <td class="p-4 font-mono text-slate-400">$${p.cost}</td>
                    <td class="p-4 font-mono text-emerald-400">$${p.price}</td>
                    <td class="p-4"><span class="bg-slate-700 px-2 py-1 rounded text-white text-xs">${p.qty}</span></td>
                </tr>`).join('');
        }

        function addToCart(id) {
            const product = productList.find(p => p.id === id);
            const currentInCart = cart.find(i => i.id === id)?.qty || 0;
            if (product.qty - currentInCart <= 0) return alert("åº«å­˜ä¸è¶³ï¼");

            const existing = cart.find(i => i.id === id);
            if(existing) existing.qty++; else cart.push({ ...product, qty: 1 });
            renderCart();
        }

        function clearCart() { cart = []; renderCart(); }

        function renderCart() {
            const container = document.getElementById('cartItems');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-600 mt-10 text-sm">å°šæœªåŠ å…¥å•†å“</div>';
            } else {
                container.innerHTML = cart.map((item, idx) => `
                    <div class="flex justify-between items-center bg-slate-800 p-3 rounded mb-2 border border-slate-700">
                        <div><span class="text-sm font-bold text-slate-200">${item.name}</span><span class="text-xs block text-slate-400">$${item.price} x ${item.qty}</span></div>
                        <div class="text-emerald-400 font-bold">$${item.price * item.qty}</div>
                    </div>`).join('');
            }
            calculateTotal();
        }

        function calculateTotal() {
            const totalQty = cart.reduce((s, i) => s + i.qty, 0);
            const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const totalCost = cart.reduce((s, i) => s + (i.cost * i.qty), 0);
            
            let discount = (totalQty >= 2) ? Math.round(subtotal * 0.15) : 0;
            const final = subtotal - discount;
            const net = final - totalCost;

            document.getElementById('cartSubtotal').innerText = `$${subtotal}`;
            document.getElementById('discountAmount').innerText = `-$${discount}`;
            document.getElementById('cartFinalTotal').innerText = `$${final}`;
            document.getElementById('discountRow').style.display = discount > 0 ? 'flex' : 'none';
            document.getElementById('profitWarning').style.display = net < 0 ? 'block' : 'none';
        }

        // ==========================================
        // ğŸš€ å‚³é€è³‡æ–™è‡³å¾Œç«¯ (æ ¸å¿ƒå°æ¥)
        // ==========================================

        async function submitSale() {
            if (cart.length === 0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
            const btn = document.getElementById('btnSale');
            const note = document.getElementById('posNote').value;
            
            const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const totalQty = cart.reduce((s, i) => s + i.qty, 0);
            const discount = (totalQty >= 2) ? Math.round(subtotal * 0.15) : 0;
            const finalTotal = subtotal - discount;
            const cogs = cart.reduce((s, i) => s + (i.cost * i.qty), 0);

            // æº–å‚™ payload (ç¬¦åˆå¾Œç«¯ handleSale æ ¼å¼)
            const payload = {
                action: "record_sale",
                auth: sessionKey,
                finalTotal: finalTotal,
                discount: discount,
                cogs: cogs,
                items: cart.map(i => ({ id: i.id, qty: i.qty })), // ç²¾ç°¡å‚³é€
                note: note
            };

            btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

            if (isOfflineMode) {
                setTimeout(() => {
                    cart.forEach(i => { const p = productList.find(p=>p.id==i.id); if(p) p.qty -= i.qty; });
                    alert("âœ… (é›¢ç·š) éŠ·å”®å·²è¨˜éŒ„");
                    clearCart(); renderProductGrid(); renderInventoryList();
                    btn.disabled = false; btn.innerText = "çµå¸³æ”¶æ¬¾";
                }, 500);
                return;
            }

            try {
                // ä½¿ç”¨ no-cors é¿å…è·¨åŸŸéŒ¯èª¤ (ä½†ç„¡æ³•è®€å– response)ï¼Œæˆ–æ¨™æº– cors
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.status === "success") {
                    alert(`âœ… äº¤æ˜“æˆåŠŸï¼\näº¤æ˜“å–®è™Ÿ: ${data.id}`);
                    cart = []; renderCart(); loadProducts(); // é‡æ–°æ•´ç†åº«å­˜
                } else {
                    alert("âŒ äº¤æ˜“å¤±æ•—: " + data.msg);
                }
            } catch (e) {
                console.error(e);
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯ç‹€æ…‹");
            } finally {
                btn.disabled = false; btn.innerText = "çµå¸³æ”¶æ¬¾";
                document.getElementById('posNote').value = "";
            }
        }

        async function submitExpense() {
            if(isOfflineMode) return alert("é›¢ç·šæ¨¡å¼ä¸æ”¯æ´å¯«å…¥è²»ç”¨");
            const payload = {
                action: "record_expense",
                auth: sessionKey,
                amount: document.getElementById('expAmount').value,
                tag: document.getElementById('expTag').value,
                tagName: document.getElementById('expTag').options[document.getElementById('expTag').selectedIndex].text,
                desc: document.getElementById('expDesc').value
            };
            // ç°¡åŒ– fetch å‘¼å«...
            fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
                .then(r => r.json()).then(d => {
                    if(d.status==="success") alert("âœ… å ±æ”¯æˆåŠŸ");
                    else alert("âŒ å¤±æ•—: " + d.msg);
                });
        }

        async function getReport() {
            if(isOfflineMode) return alert("é›¢ç·šæ¨¡å¼ç„¡å ±è¡¨åŠŸèƒ½");
            const start = document.getElementById('rptStart').value;
            const end = document.getElementById('rptEnd').value;
            if(!start || !end) return alert("è«‹é¸æ“‡æ—¥æœŸ");

            const res = await fetch(`${API_URL}?action=get_report&auth=${sessionKey}&startDate=${start}&endDate=${end}`);
            const data = await res.json();
            if(data.status === "success") {
                document.getElementById('rpt-revenue').innerText = "$" + data.report.revenue.toLocaleString();
                document.getElementById('rpt-net').innerText = "$" + data.report.net_income.toLocaleString();
            }
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
        }
        
        // åˆå§‹åŒ–æ—¥æœŸ
        document.getElementById('rptStart').valueAsDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        document.getElementById('rptEnd').valueAsDate = new Date();
    </script>
</body>
</html>
