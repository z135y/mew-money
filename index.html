<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA ERP Pro v4.0 (Secure)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .input-dark { background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; color: white; transition: all 0.2s; }
        .input-dark:focus { border-color: #10b981; outline: none; }
        .nav-btn.active { background-color: #1e293b; color: #34d399; border-right: 3px solid #34d399; }
        .report-table th, .report-table td { padding: 12px; border-bottom: 1px solid #334155; }
        .report-table th { text-align: left; color: #94a3b8; font-size: 0.85rem; }
        .report-value { font-family: 'Courier New', monospace; text-align: right; }
        
        /* ğŸ” å®‰å…¨ç™»å…¥é®ç½©æ¨£å¼ */
        #authOverlay { position: fixed; inset: 0; background: #020617; z-index: 50; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body onload="checkLoginStatus()">

    <!-- ğŸ” å®‰å…¨ç™»å…¥å±¤ (Security Layer) -->
    <div id="authOverlay">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center border-t-4 border-emerald-500">
            <h1 class="text-3xl font-bold text-white mb-2"><i class="fa-solid fa-shield-halved text-emerald-400 mr-2"></i>SCA Secure ERP</h1>
            <p class="text-slate-400 mb-6 text-sm">ç³»çµ±å·²åŠ å¯†ï¼Œè«‹è¼¸å…¥é‡‘é‘°è§£é–</p>
            <input type="password" id="authKey" class="input-dark w-full p-4 rounded-lg text-center text-xl tracking-widest mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button onclick="login()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition shadow-lg shadow-emerald-900/30">
                é©—è­‰ä¸¦ç™»å…¥ (Login)
            </button>
            <p id="loginMsg" class="text-red-400 text-sm mt-4 min-h-[20px]"></p>
        </div>
    </div>

    <!-- ä¸»ç³»çµ±ä»‹é¢ (é è¨­éš±è—ï¼Œé©—è­‰é€šéå¾Œé¡¯ç¤º) -->
    <div id="appContainer" class="flex h-screen overflow-hidden opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-xl font-bold text-emerald-400 flex items-center gap-2">
                    <i class="fa-solid fa-lock text-xs"></i> SCA ERP Pro
                </h1>
                <p class="text-xs text-slate-500 mt-1 pl-1">Secure Suite v4.0</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div class="text-xs font-bold text-slate-600 uppercase mb-2 px-2">Operations</div>
                <button onclick="switchTab('pos')" id="nav-pos" class="nav-btn active w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-cash-register w-5 text-center"></i> POS çµå¸³
                </button>
                <button onclick="switchTab('inventory')" id="nav-inventory" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-boxes-stacked w-5 text-center"></i> åº«å­˜ç®¡ç†
                </button>
                
                <div class="text-xs font-bold text-slate-600 uppercase mb-2 px-2 mt-4">Finance</div>
                <button onclick="switchTab('expense')" id="nav-expense" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-receipt w-5 text-center"></i> è²»ç”¨å ±æ”¯
                </button>
                <button onclick="switchTab('purchase')" id="nav-purchase" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i> æ¡è³¼ä»˜æ¬¾
                </button>
                <button onclick="switchTab('journal')" id="nav-journal" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-pen-to-square w-5 text-center"></i> æœƒè¨ˆå‚³ç¥¨
                </button>
                
                <div class="text-xs font-bold text-slate-600 uppercase mb-2 px-2 mt-4">Analysis</div>
                <button onclick="switchTab('report')" id="nav-report" class="nav-btn w-full text-left p-3 rounded hover:bg-slate-800 text-slate-400 transition flex items-center gap-3">
                    <i class="fa-solid fa-file-contract w-5 text-center"></i> è²¡å‹™ç¸½è¡¨
                </button>
            </nav>
            
            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full text-xs text-red-400 hover:text-red-300 text-center py-2 border border-red-900/50 rounded hover:bg-red-900/20 transition">
                    <i class="fa-solid fa-right-from-bracket mr-1"></i> å®‰å…¨ç™»å‡º
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-gradient-to-br from-slate-900 to-slate-800">
            
            <!-- Tab 1: POS -->
            <div id="pos" class="tab-content active max-w-7xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">é›¶å”®çµå¸³å°</h2>
                        <p class="text-xs text-slate-400 mt-1"><i class="fa-solid fa-shield-cat text-emerald-500"></i> å®‰å…¨åŠ å¯†å‚³è¼¸ (Secured)</p>
                    </div>
                    <button onclick="loadProducts()" class="text-sm bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-white transition flex items-center gap-2">
                        <i class="fa-solid fa-sync"></i> åŒæ­¥å•†å“
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <div class="lg:col-span-2 overflow-y-auto pr-2 pb-10">
                        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                            <div class="col-span-full text-center py-20 text-slate-500">
                                <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3"></i><br>ç­‰å¾…æˆæ¬Šä¸­...
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-0 rounded-xl flex flex-col h-[calc(100vh-8rem)]">
                        <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-white">è³¼ç‰©è»Š</h3>
                            <span class="text-xs bg-emerald-600 text-white px-2 py-1 rounded-full" id="itemCount">0</span>
                        </div>
                        <div id="cartItems" class="flex-1 space-y-2 overflow-y-auto p-4"></div>
                        <div class="bg-slate-900/80 p-5 space-y-3 border-t border-slate-700 backdrop-blur-md">
                            <div class="flex justify-between text-sm text-slate-400"><span>å°è¨ˆ</span><span id="cartSubtotal">$0</span></div>
                            <div class="flex items-center justify-between gap-2 bg-slate-800 p-2 rounded border border-slate-700">
                                <label class="text-xs text-yellow-500 font-bold whitespace-nowrap">æŠ˜æ‰£</label>
                                <input type="number" id="manualDiscount" oninput="calculateTotal()" class="bg-transparent text-right text-yellow-400 text-sm outline-none w-24 placeholder-slate-600" placeholder="0">
                            </div>
                            <div class="flex justify-between text-2xl font-bold text-white border-t border-slate-700 pt-3">
                                <span>ç¸½è¨ˆ (å«ç¨…)</span>
                                <span id="cartFinalTotal" class="text-emerald-400">$0</span>
                            </div>
                            <input type="text" id="posNote" class="input-dark w-full p-2 rounded text-sm" placeholder="ğŸ“ è¨‚å–®å‚™è¨» (å€‹è³‡å°‡åŠ å¯†)">
                            <button onclick="submitSale()" id="btnSale" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition">çµå¸³æ”¶æ¬¾</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Inventory -->
            <div id="inventory" class="tab-content max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400">åº«å­˜ç®¡ç†</h2>
                    <button onclick="loadProducts()" class="text-sm bg-slate-800 px-3 py-1 rounded text-slate-400 hover:text-white transition"><i class="fa-solid fa-sync"></i> Refresh</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="glass-panel p-6 rounded-xl border-t-4 border-cyan-500">
                        <h3 class="text-lg font-bold text-white mb-6">ä¸Šæ¶æ–°å•†å“</h3>
                        <div class="space-y-4">
                            <input type="text" id="newProdName" class="input-dark w-full p-3 rounded" placeholder="å“å">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="newProdPrice" class="input-dark w-full p-3 rounded" placeholder="å®šåƒ¹">
                                <input type="number" id="newProdCost" class="input-dark w-full p-3 rounded" placeholder="æˆæœ¬">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">å…¥åº«æ—¥æœŸ</label>
                                    <input type="date" id="newProdInDate" class="input-dark w-full p-2 rounded text-sm text-gray-300">
                                </div>
                                <div>
                                    <label class="block text-xs text-red-300 mb-1">æœ‰æ•ˆæœŸé™</label>
                                    <input type="date" id="newProdExpDate" class="input-dark w-full p-2 rounded text-sm text-gray-300">
                                </div>
                            </div>
                            <input type="number" id="newProdQty" class="input-dark w-full p-3 rounded" placeholder="åˆå§‹åº«å­˜">
                            <button onclick="addProduct()" id="btnAddProd" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-2 rounded font-bold mt-2">ä¸Šæ¶</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 glass-panel p-0 rounded-xl border-t-4 border-emerald-500 flex flex-col overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-900/50"><tr><th class="p-4">å“å</th><th class="p-4">åº«å­˜</th><th class="p-4">æ“ä½œ</th></tr></thead>
                            <tbody id="inventoryList" class="text-sm divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 3 & 4: Expense & Purchase -->
            <div id="expense" class="tab-content max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-blue-400">è²»ç”¨å ±æ”¯</h2>
                <div class="glass-panel p-8 rounded-xl border-t-4 border-blue-500 space-y-4">
                    <input type="number" id="expAmount" class="input-dark w-full p-3 rounded" placeholder="é‡‘é¡">
                    <select id="expTag" class="input-dark w-full p-3 rounded"><option value="staff">ä¼™é£Ÿè²»</option><option value="client">äº¤éš›è²»</option><option value="meeting">æœƒè­°è²»</option><option value="travel">æ—…è²»</option></select>
                    <input type="text" id="expDesc" class="input-dark w-full p-3 rounded" placeholder="æ‘˜è¦ (å€‹è³‡å°‡åŠ å¯†)">
                    <button onclick="submitExpense()" id="btnExp" class="w-full bg-blue-600 text-white py-3 rounded font-bold">æäº¤</button>
                </div>
            </div>

            <div id="purchase" class="tab-content max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-purple-400">æ¡è³¼ä»˜æ¬¾</h2>
                <div class="glass-panel p-8 rounded-xl border-t-4 border-purple-500 space-y-4">
                    <input type="number" id="payAmount" class="input-dark w-full p-3 rounded" placeholder="æ‡‰ä»˜é‡‘é¡">
                    <div class="grid grid-cols-2 gap-4"><input type="date" id="invDate" class="input-dark w-full p-3 rounded"><input type="date" id="payDate" class="input-dark w-full p-3 rounded"></div>
                    <input type="text" id="payNote" class="input-dark w-full p-3 rounded" placeholder="å‚™è¨» (å€‹è³‡å°‡åŠ å¯†)">
                    <button onclick="submitPayment()" id="btnPay" class="w-full bg-purple-600 text-white py-3 rounded font-bold">ä»˜æ¬¾</button>
                </div>
            </div>

            <!-- Tab 5: Journal -->
            <div id="journal" class="tab-content max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-slate-300">æœƒè¨ˆå‚³ç¥¨</h2>
                <div class="glass-panel p-8 rounded-xl border-t-4 border-slate-500">
                    <div class="flex justify-between items-center mb-4">
                        <input type="date" id="jnlDate" class="input-dark p-2 rounded">
                        <span class="text-xs text-slate-400">å€Ÿè²¸éœ€å¹³è¡¡</span>
                    </div>
                    <div id="journalEntries" class="space-y-2 mb-4">
                        <div class="grid grid-cols-12 gap-2 text-xs uppercase text-slate-500 mb-1">
                            <div class="col-span-4">ç§‘ç›®</div>
                            <div class="col-span-4">æ‘˜è¦</div>
                            <div class="col-span-2 text-right">å€Ÿ (Dr)</div>
                            <div class="col-span-2 text-right">è²¸ (Cr)</div>
                        </div>
                        <div class="grid grid-cols-12 gap-2 jnl-row">
                            <input type="text" class="col-span-4 input-dark p-2 rounded jnl-ac" placeholder="ç§‘ç›®">
                            <input type="text" class="col-span-4 input-dark p-2 rounded jnl-desc" placeholder="æ‘˜è¦">
                            <input type="number" class="col-span-2 input-dark p-2 rounded text-right jnl-dr" placeholder="0" oninput="calcJnlBalance()">
                            <input type="number" class="col-span-2 input-dark p-2 rounded text-right jnl-cr" placeholder="0" oninput="calcJnlBalance()">
                        </div>
                        <div class="grid grid-cols-12 gap-2 jnl-row">
                            <input type="text" class="col-span-4 input-dark p-2 rounded jnl-ac" placeholder="ç§‘ç›®">
                            <input type="text" class="col-span-4 input-dark p-2 rounded jnl-desc" placeholder="æ‘˜è¦">
                            <input type="number" class="col-span-2 input-dark p-2 rounded text-right jnl-dr" placeholder="0" oninput="calcJnlBalance()">
                            <input type="number" class="col-span-2 input-dark p-2 rounded text-right jnl-cr" placeholder="0" oninput="calcJnlBalance()">
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t border-slate-700 pt-4">
                        <button onclick="addJnlRow()" class="text-sm text-cyan-400 hover:text-cyan-300"><i class="fa-solid fa-plus"></i> æ–°å¢ä¸€è¡Œ</button>
                        <div class="text-right">
                            <div class="text-sm text-slate-400">å·®é¡: <span id="jnlDiff" class="text-emerald-400 font-mono font-bold">0</span></div>
                        </div>
                    </div>
                    <button onclick="submitJournal()" id="btnJnl" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg font-bold mt-4 transition">éå¸³ (Post)</button>
                </div>
            </div>

            <!-- Tab 6: Reports -->
            <div id="report" class="tab-content max-w-5xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-amber-400">è²¡å‹™æç›Šè¡¨</h2>
                    <div class="flex gap-2">
                        <input type="date" id="rptStart" class="input-dark p-2 rounded text-sm">
                        <span class="text-slate-500 self-center">to</span>
                        <input type="date" id="rptEnd" class="input-dark p-2 rounded text-sm">
                        <button onclick="generateReport()" id="btnRpt" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded text-sm font-bold transition">ç”Ÿæˆå ±è¡¨</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 glass-panel p-0 rounded-xl border-t-4 border-amber-500 overflow-hidden">
                        <div class="p-4 bg-slate-900/50 border-b border-slate-700 font-bold">Income Statement (NTD)</div>
                        <table class="w-full text-sm report-table">
                            <tbody>
                                <tr><td>éŠ·è²¨æ”¶å…¥ (Revenue)</td><td id="rpt-rev" class="report-value text-emerald-400">0</td></tr>
                                <tr><td>éŠ·è²¨æˆæœ¬ (COGS)</td><td id="rpt-cogs" class="report-value text-red-400">0</td></tr>
                                <tr class="bg-slate-800/50 font-bold"><td>éŠ·è²¨æ¯›åˆ© (Gross Profit)</td><td id="rpt-gp" class="report-value text-slate-200">0</td></tr>
                                <tr><td>ç‡Ÿæ¥­è²»ç”¨ (Expenses)</td><td id="rpt-exp" class="report-value text-red-300">0</td></tr>
                                <tr class="bg-slate-800/50 font-bold text-lg border-t-2 border-slate-600"><td>æœ¬æœŸæ·¨åˆ© (Net Income)</td><td id="rpt-net" class="report-value text-amber-400">0</td></tr>
                            </tbody>
                        </table>
                        <div class="p-4 text-xs text-slate-500 border-t border-slate-700">
                            * è¨»ï¼šéŠ·é …ç¨…é¡ (Liability) ç´¯è¨ˆ: <span id="rpt-tax" class="text-slate-300 font-mono">0</span>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl">
                        <canvas id="rptChart"></canvas>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ âš ï¸
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxDcZyACW4wb1DyfZuexXepTSkF0l9nPk1LDAHY4jp1DCI7rKCrOdKD8WAc_EsWCSwZ/exec"; 
        // ==========================================
        
        let productList = []; 
        let cart = [];
        let rptChartInstance = null;
        let sessionKey = null;

        // ğŸ” å®‰å…¨ç™»å…¥é‚è¼¯
        function checkLoginStatus() {
            const storedKey = sessionStorage.getItem("sca_api_key");
            if(storedKey) {
                sessionKey = storedKey;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('appContainer').style.opacity = '1';
                document.getElementById('appContainer').style.pointerEvents = 'auto'; // å•Ÿç”¨é»æ“Š
                initSystem();
            }
        }

        function login() {
            const key = document.getElementById('authKey').value;
            if(!key) { document.getElementById('loginMsg').innerText = "è«‹è¼¸å…¥é‡‘é‘°"; return; }
            
            // ç°¡æ˜“é©—è­‰ï¼šå˜—è©¦é€²è¡Œä¸€æ¬¡è«‹æ±‚
            sessionKey = key;
            sessionStorage.setItem("sca_api_key", key);
            
            loadProducts(true).then(success => {
                if(success) {
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('appContainer').style.opacity = '1';
                    document.getElementById('appContainer').style.pointerEvents = 'auto';
                    initSystem();
                } else {
                    document.getElementById('loginMsg').innerText = "âŒ é‡‘é‘°éŒ¯èª¤æˆ–é€£ç·šå¤±æ•—";
                    sessionStorage.removeItem("sca_api_key");
                    sessionKey = null;
                }
            });
        }

        function logout() {
            sessionStorage.removeItem("sca_api_key");
            location.reload();
        }

        function initSystem() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('payDate').valueAsDate = today;
            document.getElementById('jnlDate').valueAsDate = today;
            document.getElementById('rptStart').valueAsDate = firstDay;
            document.getElementById('rptEnd').valueAsDate = today;
            document.getElementById('newProdInDate').valueAsDate = today;
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active', 'text-emerald-400', 'border-r-2', 'border-emerald-400'));
            const activeBtn = document.getElementById('nav-' + id);
            if(activeBtn) activeBtn.classList.add('active');
        }

        // --- æ ¸å¿ƒï¼šå•†å“è¼‰å…¥ ---
        async function loadProducts(isLoginCheck = false) {
            const grid = document.getElementById('productGrid');
            try {
                const res = await fetch(`${API_URL}?action=get_products`);
                const data = await res.json();
                
                if(data.status === "success") {
                    productList = data.products;
                    if(!isLoginCheck) {
                        renderProductGrid();
                        renderInventoryList();
                    }
                    return true;
                } else {
                    if(!isLoginCheck) grid.innerHTML = "è¼‰å…¥å¤±æ•—";
                    return false;
                }
            } catch(e) { 
                console.error(e); 
                return false; 
            }
        }

        // --- æ¸²æŸ“ (èˆ‡ v3.1 ç›¸åŒï¼Œå«æ—¥æœŸé¡¯ç¤º) ---
        function renderProductGrid() {
            document.getElementById('productGrid').innerHTML = productList.map(p => `
                <div onclick="addToCart('${p.id}', '${p.name}', ${p.price}, ${p.cost})" 
                     class="glass-panel p-4 rounded-xl cursor-pointer hover:bg-slate-700 transition active:scale-95 border-l-4 border-transparent hover:border-emerald-500 h-32 flex flex-col justify-between">
                    <div class="text-slate-100 font-bold text-lg line-clamp-2">${p.name}</div>
                    <div class="flex justify-between items-end">
                        <div class="text-emerald-400 font-mono text-xl font-bold">$${p.price}</div>
                        <div class="text-xs ${p.qty<5?'text-red-400 font-bold':'text-slate-400'}">åº«å­˜: ${p.qty}</div>
                    </div>
                </div>`).join('');
        }

        function renderInventoryList() {
            document.getElementById('inventoryList').innerHTML = productList.map(p => {
                const expDisplay = p.expDate ? `<div class="text-xs text-red-300 mt-1"><i class="fa-regular fa-clock mr-1"></i>Exp: ${p.expDate.split('T')[0]}</div>` : '';
                return `<tr class="border-b border-slate-700 hover:bg-slate-800">
                    <td class="p-4">${p.name} <span class="text-xs text-slate-500 block">${p.id}</span>${expDisplay}</td>
                    <td class="p-4"><input type="number" id="stock-${p.id}" value="${p.qty}" class="input-dark w-20 p-1 text-center" onchange="document.getElementById('btn-upd-${p.id}').classList.remove('invisible')"></td>
                    <td class="p-4"><button id="btn-upd-${p.id}" onclick="updateStock('${p.id}')" class="invisible bg-emerald-600 text-white px-3 py-1 rounded text-xs">æ›´æ–°</button></td>
                </tr>`;
            }).join('');
        }

        function addToCart(id, name, price, cost) {
            const item = cart.find(i => i.id === id);
            if(item) item.qty++; else cart.push({id, name, price, cost, qty: 1});
            renderCart();
        }

        function renderCart() {
            document.getElementById('cartItems').innerHTML = cart.map((item, idx) => `
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded mb-2 border border-slate-700">
                    <div class="flex-1">
                        <span class="text-sm block text-slate-200">${item.name}</span>
                        <span class="text-xs text-slate-400">$${item.price} x ${item.qty}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-mono text-emerald-400 font-bold text-sm">$${item.price * item.qty}</span>
                        <button onclick="changeQty(${idx}, -1)" class="text-slate-400 hover:text-white bg-slate-700 px-2 py-0.5 rounded text-sm">-</button>
                        <button onclick="changeQty(${idx}, 1)" class="text-slate-400 hover:text-white bg-slate-700 px-2 py-0.5 rounded text-sm">+</button>
                    </div>
                </div>`).join('');
            document.getElementById('itemCount').innerText = cart.reduce((s, i) => s + i.qty, 0);
            calculateTotal();
        }
        
        function changeQty(idx, d) {
            if(cart[idx].qty + d <= 0) { if(confirm("ç§»é™¤?")) cart.splice(idx, 1); } 
            else cart[idx].qty += d;
            renderCart();
        }

        function calculateTotal() {
            const sub = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const disc = Number(document.getElementById('manualDiscount').value) || 0;
            document.getElementById('cartSubtotal').innerText = `$${sub}`;
            document.getElementById('cartFinalTotal').innerText = `$${Math.max(0, sub - disc)}`;
        }

        // --- è³‡æ–™å‚³é€ (Secure Mode) ---
        // âš ï¸ é—œéµï¼šæ‰€æœ‰ POST è«‹æ±‚éƒ½å¿…é ˆå¸¶ä¸Š auth: sessionKey
        
        function updateStock(id) {
            sendData({
                action: "update_inventory", auth: sessionKey,
                id: id, qty: document.getElementById(`stock-${id}`).value
            }, `btn-upd-${id}`, "å·²æ›´æ–°", () => {
                document.getElementById(`btn-upd-${id}`).classList.add('invisible'); loadProducts();
            });
        }

        function addProduct() {
            sendData({
                action: "add_product", auth: sessionKey,
                name: document.getElementById('newProdName').value,
                price: document.getElementById('newProdPrice').value,
                cost: document.getElementById('newProdCost').value,
                qty: document.getElementById('newProdQty').value,
                inboundDate: document.getElementById('newProdInDate').value,
                expiryDate: document.getElementById('newProdExpDate').value
            }, "btnAddProd", "å·²ä¸Šæ¶", () => { loadProducts(); });
        }

        function submitSale() {
            if(cart.length===0) return alert("ç©ºè»Š");
            const sub = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const disc = Number(document.getElementById('manualDiscount').value) || 0;
            const total = Math.max(0, sub - disc);
            const cogs = cart.reduce((s, i) => s + (i.cost * i.qty), 0);
            sendData({
                action: "record_sale", auth: sessionKey,
                originalTotal: sub, discount: disc, finalTotal: total, cogs: cogs,
                items: cart, note: document.getElementById('posNote').value
            }, "btnSale", "å®Œæˆ", () => { cart=[]; renderCart(); loadProducts(); });
        }

        function submitExpense() {
            sendData({
                action: "record_expense", auth: sessionKey,
                amount: document.getElementById('expAmount').value,
                tag: document.getElementById('expTag').value,
                desc: document.getElementById('expDesc').value
            }, "btnExp", "å·²ç”³å ±", () => {});
        }

        function submitPayment() {
            sendData({
                action: "record_purchase_payment", auth: sessionKey,
                amount: document.getElementById('payAmount').value,
                invoiceDate: document.getElementById('invDate').value,
                note: document.getElementById('payNote').value
            }, "btnPay", "å·²ä»˜æ¬¾", () => {});
        }

        function submitJournal() {
            if(Number(document.getElementById('jnlDiff').innerText) !== 0) return alert("ä¸å¹³è¡¡");
            let entries = [];
            document.querySelectorAll('.jnl-row').forEach(row => {
                const ac = row.querySelector('.jnl-ac').value;
                if(ac) entries.push({
                    account: ac, desc: row.querySelector('.jnl-desc').value,
                    dr: row.querySelector('.jnl-dr').value || 0, cr: row.querySelector('.jnl-cr').value || 0
                });
            });
            if(entries.length===0) return alert("è«‹è¼¸å…¥");
            sendData({
                action: "record_manual_journal", auth: sessionKey,
                date: document.getElementById('jnlDate').value, entries: entries
            }, "btnJnl", "å·²éå¸³", () => {
                document.querySelectorAll('.jnl-dr, .jnl-cr, .jnl-ac, .jnl-desc').forEach(i => i.value = "");
                calcJnlBalance();
            });
        }

        function sendData(payload, btnId, msg, callback) {
            const btn = document.getElementById(btnId);
            if(btn) btn.disabled = true;
            fetch(API_URL, {method: "POST", mode: "no-cors", body: JSON.stringify(payload)})
            .then(() => { alert(msg); if(callback) callback(); })
            .catch(e => alert("éŒ¯èª¤"))
            .finally(() => { if(btn) btn.disabled = false; });
        }
    </script>
</body>
</html>
